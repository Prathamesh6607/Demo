{% extends 'base.html' %}
{% block title %}NIST Cybersecurity Framework Report - IoT NIST Monitor{% endblock %}
{% block content %}
<style>
  @media print {
    .no-print, nav, footer { display: none !important; }
    body { background: white !important; }
    .card { border: 1px solid #ddd !important; page-break-inside: avoid; }
  }
  .report-header { background: linear-gradient(135deg, #2c3e50, #3498db); color: white; padding: 2rem; border-radius: 8px; margin-bottom: 2rem; }
  .function-section { margin-bottom: 2rem; page-break-inside: avoid; }
  .compliance-badge { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 4px; font-size: 0.85rem; font-weight: 600; }
  .compliance-high { background: #d4edda; color: #155724; }
  .compliance-medium { background: #fff3cd; color: #856404; }
  .compliance-low { background: #f8d7da; color: #721c24; }
  .metric-card { border-left: 4px solid #3498db; }
  .metric-value { font-size: 2rem; font-weight: bold; color: #2c3e50; }
  .iso-mapping { background: #f8f9fa; padding: 1rem; border-radius: 4px; font-size: 0.9rem; }
  table.report-table { font-size: 0.9rem; }
  table.report-table th { background: #e9ecef; font-weight: 600; }
</style>

<div class="no-print mb-3">
  <button onclick="window.print()" class="btn btn-primary"><i class="fas fa-print me-2"></i>Print Report</button>
  <a href="{{ url_for('download_report_pdf') }}" class="btn btn-success"><i class="fas fa-file-pdf me-2"></i>Download PDF</a>
  <a href="{{ url_for('index') }}" class="btn btn-outline-secondary"><i class="fas fa-arrow-left me-2"></i>Back to Dashboard</a>
</div>

<div class="report-header text-center">
  <h1 class="mb-2"><i class="fas fa-shield-alt me-3"></i>IoT Security Compliance Report</h1>
  <h4 class="mb-3">NIST Cybersecurity Framework & ISO 27001 Assessment</h4>
  <p class="mb-1"><strong>Report Generated:</strong> {{ report_data.timestamp if report_data else 'N/A' }}</p>
  <p class="mb-0"><strong>Organization:</strong> {{ report_data.org_name if report_data else 'IoT NIST Monitor' }}</p>
</div>

<!-- Executive Summary -->
<div class="card function-section">
  <div class="card-header bg-dark text-white">
    <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Executive Summary</h5>
  </div>
  <div class="card-body">
    <div class="row g-3">
      <div class="col-md-3">
        <div class="card metric-card">
          <div class="card-body text-center">
            <div class="metric-value text-primary">{{ report_data.total_devices if report_data else 0 }}</div>
            <div class="text-muted">Total Assets</div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card metric-card">
          <div class="card-body text-center">
            <div class="metric-value text-danger">{{ report_data.critical_issues if report_data else 0 }}</div>
            <div class="text-muted">Critical Issues</div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card metric-card">
          <div class="card-body text-center">
            <div class="metric-value text-warning">{{ report_data.open_incidents if report_data else 0 }}</div>
            <div class="text-muted">Open Incidents</div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card metric-card">
          <div class="card-body text-center">
            <div class="metric-value text-success">{{ report_data.compliance_score if report_data else 0 }}%</div>
            <div class="text-muted">Compliance Score</div>
          </div>
        </div>
      </div>
    </div>
    <hr>
    <p><strong>Overall Assessment:</strong> {{ report_data.summary if report_data else 'No assessment data available. Please complete scans across all NIST functions.' }}</p>
    <div class="iso-mapping">
      <strong>ISO 27001 Mapping:</strong> This report addresses controls from A.8 (Asset Management), A.12 (Operations Security), A.16 (Information Security Incident Management), and A.17 (Business Continuity).
    </div>
  </div>
</div>

<!-- IDENTIFY Function -->
<div class="card function-section">
  <div class="card-header" style="background: #3498db; color: white;">
    <h5 class="mb-0"><i class="fas fa-search me-2"></i>IDENTIFY (ID) - Asset Management & Risk Assessment</h5>
  </div>
  <div class="card-body">
    <div class="row mb-3">
      <div class="col-md-6">
        <p><strong>NIST Category:</strong> ID.AM - Asset Management</p>
        <p><strong>ISO 27001:</strong> A.8.1 Responsibility for assets, A.8.2 Information classification</p>
      </div>
      <div class="col-md-6 text-end">
        <span class="compliance-badge compliance-{{ report_data.identify_compliance_level if report_data else 'low' }}">
          {{ report_data.identify_compliance if report_data else 'Not Assessed' }}
        </span>
      </div>
    </div>
    
    <h6 class="mb-3">Discovered Assets</h6>
    <table class="table table-sm table-hover report-table">
      <thead>
        <tr>
          <th>Asset Name</th>
          <th>Type</th>
          <th>IP Address</th>
          <th>MAC Address</th>
          <th>Risk Level</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        {% if report_data and report_data.devices %}
          {% for device in report_data.devices %}
          <tr>
            <td>{{ device.name }}</td>
            <td>{{ device.type }}</td>
            <td>{{ device.ip or '—' }}</td>
            <td>{{ device.mac or '—' }}</td>
            <td><span class="badge bg-{{ device.risk_color }}">{{ device.risk_level }}</span></td>
            <td>{{ device.status }}</td>
          </tr>
          {% endfor %}
        {% else %}
          <tr><td colspan="6" class="text-center text-muted">No assets discovered. Run network scan from Identify page.</td></tr>
        {% endif %}
      </tbody>
    </table>
    
    <h6 class="mt-4 mb-3">Risk Register</h6>
    <table class="table table-sm report-table">
      <thead>
        <tr>
          <th>Risk ID</th>
          <th>Description</th>
          <th>Likelihood</th>
          <th>Impact</th>
          <th>Overall Risk</th>
        </tr>
      </thead>
      <tbody>
        {% if report_data and report_data.risks %}
          {% for risk in report_data.risks %}
          <tr>
            <td>{{ risk.id }}</td>
            <td>{{ risk.description }}</td>
            <td>{{ risk.likelihood }}</td>
            <td>{{ risk.impact }}</td>
            <td><span class="badge bg-{{ risk.level_color }}">{{ risk.overall }}</span></td>
          </tr>
          {% endfor %}
        {% else %}
          <tr><td colspan="5" class="text-center text-muted">No risk assessment data available.</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<!-- PROTECT Function -->
<div class="card function-section">
  <div class="card-header" style="background: #27ae60; color: white;">
    <h5 class="mb-0"><i class="fas fa-shield-alt me-2"></i>PROTECT (PR) - Safeguards & Security Controls</h5>
  </div>
  <div class="card-body">
    <div class="row mb-3">
      <div class="col-md-6">
        <p><strong>NIST Category:</strong> PR.AC - Access Control, PR.DS - Data Security</p>
        <p><strong>ISO 27001:</strong> A.9 Access Control, A.10 Cryptography, A.12 Operations Security</p>
      </div>
      <div class="col-md-6 text-end">
        <span class="compliance-badge compliance-{{ report_data.protect_compliance_level if report_data else 'low' }}">
          {{ report_data.protect_compliance if report_data else 'Not Assessed' }}
        </span>
      </div>
    </div>
    
    <h6 class="mb-3">Security Controls Status</h6>
    <table class="table table-sm report-table">
      <thead>
        <tr>
          <th>Control ID</th>
          <th>Control Name</th>
          <th>Status</th>
          <th>Coverage</th>
          <th>Last Verified</th>
        </tr>
      </thead>
      <tbody>
        {% if report_data and report_data.controls %}
          {% for control in report_data.controls %}
          <tr>
            <td>{{ control.id }}</td>
            <td>{{ control.name }}</td>
            <td><span class="badge bg-{{ control.status_color }}">{{ control.status }}</span></td>
            <td>{{ control.coverage }}%</td>
            <td>{{ control.verified }}</td>
          </tr>
          {% endfor %}
        {% else %}
          <tr><td colspan="5" class="text-center text-muted">No protection controls configured.</td></tr>
        {% endif %}
      </tbody>
    </table>
    
    <h6 class="mt-4 mb-3">Vulnerability Summary</h6>
    <div class="row">
      <div class="col-md-4">
        <div class="card border-danger">
          <div class="card-body text-center">
            <h3 class="text-danger">{{ report_data.vuln_critical if report_data else 0 }}</h3>
            <p class="mb-0">Critical</p>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card border-warning">
          <div class="card-body text-center">
            <h3 class="text-warning">{{ report_data.vuln_high if report_data else 0 }}</h3>
            <p class="mb-0">High</p>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card border-info">
          <div class="card-body text-center">
            <h3 class="text-info">{{ report_data.vuln_medium if report_data else 0 }}</h3>
            <p class="mb-0">Medium</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- DETECT Function -->
<div class="card function-section">
  <div class="card-header" style="background: #e67e22; color: white;">
    <h5 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>DETECT (DE) - Anomalies & Security Events</h5>
  </div>
  <div class="card-body">
    <div class="row mb-3">
      <div class="col-md-6">
        <p><strong>NIST Category:</strong> DE.AE - Anomalies and Events, DE.CM - Continuous Monitoring</p>
        <p><strong>ISO 27001:</strong> A.12.4 Logging and monitoring, A.16.1 Incident detection</p>
      </div>
      <div class="col-md-6 text-end">
        <span class="compliance-badge compliance-{{ report_data.detect_compliance_level if report_data else 'low' }}">
          {{ report_data.detect_compliance if report_data else 'Not Assessed' }}
        </span>
      </div>
    </div>
    
    <h6 class="mb-3">Security Events (Last 30 Days)</h6>
    <table class="table table-sm report-table">
      <thead>
        <tr>
          <th>Timestamp</th>
          <th>Event Type</th>
          <th>Source</th>
          <th>Severity</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
        {% if report_data and report_data.events %}
          {% for event in report_data.events %}
          <tr>
            <td>{{ event.timestamp }}</td>
            <td>{{ event.type }}</td>
            <td>{{ event.source }}</td>
            <td><span class="badge bg-{{ event.severity_color }}">{{ event.severity }}</span></td>
            <td>{{ event.description }}</td>
          </tr>
          {% endfor %}
        {% else %}
          <tr><td colspan="5" class="text-center text-muted">No security events detected.</td></tr>
        {% endif %}
      </tbody>
    </table>
    
    <h6 class="mt-4 mb-3">Anomaly Detection Summary</h6>
    <p><strong>Total Anomalies Detected:</strong> {{ report_data.total_anomalies if report_data else 0 }}</p>
    <p><strong>Mean Time to Detect (MTTD):</strong> {{ report_data.mttd if report_data else 'N/A' }}</p>
  </div>
</div>

<!-- RESPOND Function -->
<div class="card function-section">
  <div class="card-header" style="background: #e74c3c; color: white;">
    <h5 class="mb-0"><i class="fas fa-ambulance me-2"></i>RESPOND (RS) - Incident Response & Mitigation</h5>
  </div>
  <div class="card-body">
    <div class="row mb-3">
      <div class="col-md-6">
        <p><strong>NIST Category:</strong> RS.RP - Response Planning, RS.MI - Mitigation</p>
        <p><strong>ISO 27001:</strong> A.16.1 Management of information security incidents and improvements</p>
      </div>
      <div class="col-md-6 text-end">
        <span class="compliance-badge compliance-{{ report_data.respond_compliance_level if report_data else 'low' }}">
          {{ report_data.respond_compliance if report_data else 'Not Assessed' }}
        </span>
      </div>
    </div>
    
    <h6 class="mb-3">Incident Register</h6>
    <table class="table table-sm report-table">
      <thead>
        <tr>
          <th>Incident ID</th>
          <th>Type</th>
          <th>Severity</th>
          <th>Status</th>
          <th>Opened</th>
          <th>Resolved</th>
        </tr>
      </thead>
      <tbody>
        {% if report_data and report_data.incidents %}
          {% for incident in report_data.incidents %}
          <tr>
            <td>{{ incident.id }}</td>
            <td>{{ incident.type }}</td>
            <td><span class="badge bg-{{ incident.severity_color }}">{{ incident.severity }}</span></td>
            <td><span class="badge bg-{{ incident.status_color }}">{{ incident.status }}</span></td>
            <td>{{ incident.opened }}</td>
            <td>{{ incident.resolved or '—' }}</td>
          </tr>
          {% endfor %}
        {% else %}
          <tr><td colspan="6" class="text-center text-muted">No incidents recorded.</td></tr>
        {% endif %}
      </tbody>
    </table>
    
    <h6 class="mt-4 mb-3">Response Metrics</h6>
    <p><strong>Mean Time to Respond (MTTR):</strong> {{ report_data.mttr if report_data else 'N/A' }}</p>
    <p><strong>Incident Closure Rate:</strong> {{ report_data.closure_rate if report_data else 0 }}%</p>
  </div>
</div>

<!-- RECOVER Function -->
<div class="card function-section">
  <div class="card-header" style="background: #9b59b6; color: white;">
    <h5 class="mb-0"><i class="fas fa-redo me-2"></i>RECOVER (RC) - Resilience & Business Continuity</h5>
  </div>
  <div class="card-body">
    <div class="row mb-3">
      <div class="col-md-6">
        <p><strong>NIST Category:</strong> RC.RP - Recovery Planning, RC.IM - Improvements</p>
        <p><strong>ISO 27001:</strong> A.17 Business continuity management, A.17.1 Information security continuity</p>
      </div>
      <div class="col-md-6 text-end">
        <span class="compliance-badge compliance-{{ report_data.recover_compliance_level if report_data else 'low' }}">
          {{ report_data.recover_compliance if report_data else 'Not Assessed' }}
        </span>
      </div>
    </div>
    
    <h6 class="mb-3">Recovery Capabilities</h6>
    <table class="table table-sm report-table">
      <thead>
        <tr>
          <th>Capability</th>
          <th>Status</th>
          <th>RTO</th>
          <th>RPO</th>
          <th>Last Tested</th>
        </tr>
      </thead>
      <tbody>
        {% if report_data and report_data.recovery %}
          {% for item in report_data.recovery %}
          <tr>
            <td>{{ item.capability }}</td>
            <td><span class="badge bg-{{ item.status_color }}">{{ item.status }}</span></td>
            <td>{{ item.rto }}</td>
            <td>{{ item.rpo }}</td>
            <td>{{ item.tested }}</td>
          </tr>
          {% endfor %}
        {% else %}
          <tr><td colspan="5" class="text-center text-muted">No recovery plans configured.</td></tr>
        {% endif %}
      </tbody>
    </table>
    
    <h6 class="mt-4 mb-3">Business Continuity Status</h6>
    <p><strong>Backup Success Rate:</strong> {{ report_data.backup_success if report_data else 0 }}%</p>
    <p><strong>Recovery Time Objective (RTO):</strong> {{ report_data.rto if report_data else 'Not Defined' }}</p>
    <p><strong>Recovery Point Objective (RPO):</strong> {{ report_data.rpo if report_data else 'Not Defined' }}</p>
  </div>
</div>

<!-- Compliance Summary -->
<div class="card function-section">
  <div class="card-header bg-info text-white">
    <h5 class="mb-0"><i class="fas fa-check-circle me-2"></i>Compliance & Recommendations</h5>
  </div>
  <div class="card-body">
    <h6 class="mb-3">NIST CSF Compliance Overview</h6>
    <div class="row mb-4">
      <div class="col-md-2">
        <div class="text-center">
          <div class="h4 text-primary">{{ report_data.identify_score if report_data else 0 }}%</div>
          <small>Identify</small>
        </div>
      </div>
      <div class="col-md-2">
        <div class="text-center">
          <div class="h4 text-success">{{ report_data.protect_score if report_data else 0 }}%</div>
          <small>Protect</small>
        </div>
      </div>
      <div class="col-md-2">
        <div class="text-center">
          <div class="h4 text-warning">{{ report_data.detect_score if report_data else 0 }}%</div>
          <small>Detect</small>
        </div>
      </div>
      <div class="col-md-2">
        <div class="text-center">
          <div class="h4 text-danger">{{ report_data.respond_score if report_data else 0 }}%</div>
          <small>Respond</small>
        </div>
      </div>
      <div class="col-md-2">
        <div class="text-center">
          <div class="h4" style="color: #9b59b6;">{{ report_data.recover_score if report_data else 0 }}%</div>
          <small>Recover</small>
        </div>
      </div>
      <div class="col-md-2">
        <div class="text-center">
          <div class="h4 text-dark">{{ report_data.overall_score if report_data else 0 }}%</div>
          <small>Overall</small>
        </div>
      </div>
    </div>
    
    <h6 class="mb-3">Key Recommendations</h6>
    <ul>
      {% if report_data and report_data.recommendations %}
        {% for rec in report_data.recommendations %}
        <li>{{ rec }}</li>
        {% endfor %}
      {% else %}
        <li>Complete asset discovery scans to establish baseline inventory</li>
        <li>Implement vulnerability scanning and risk assessment procedures</li>
        <li>Configure security monitoring and anomaly detection</li>
        <li>Establish incident response procedures and playbooks</li>
        <li>Develop and test business continuity and disaster recovery plans</li>
      {% endif %}
    </ul>
    
    <div class="iso-mapping mt-4">
      <strong>ISO 27001:2022 Alignment:</strong> This assessment covers Annex A controls including A.5 (Organizational), A.8 (Asset Management), A.9 (Access Control), A.12 (Operations Security), A.16 (Incident Management), and A.17 (Business Continuity). Regular reassessment recommended quarterly.
    </div>
  </div>
</div>

<div class="text-center mt-4 mb-4 no-print">
  <button onclick="window.print()" class="btn btn-primary btn-lg"><i class="fas fa-print me-2"></i>Print Report</button>
  <a href="{{ url_for('download_report_pdf') }}" class="btn btn-success btn-lg"><i class="fas fa-file-pdf me-2"></i>Download PDF</a>
</div>

{% endblock %}
