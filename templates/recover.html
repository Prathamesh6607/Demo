{% extends "base.html" %}
{% block content %}

<div class="container mt-4">
  <h2 class="mb-4">ðŸ›  NIST Phase 5: Recover</h2>

  <!-- Start Scan Button -->
  <div class="text-center mb-4">
    <button id="scanBtn" class="btn btn-primary">
      ðŸ”„ Start Recovery Scan
    </button>
  </div>

  <!-- OTA Progress -->
  <div class="mb-4">
    <h5>ðŸ“¡ OTA Update Progress</h5>
    <div class="progress" style="height: 25px;">
      <div id="otaProgress" class="progress-bar bg-primary" role="progressbar"
           style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%
      </div>
    </div>
  </div>

  <!-- Recovery Mechanisms -->
  <div id="recoverySection" style="display: none;">
    <div class="mb-5">
      <h4>âš™ Recovery Mechanisms</h4>
      <div id="mechanismsContainer" class="row"></div>
    </div>

    <!-- IoT Devices -->
    <div class="mb-5">
      <h4>ðŸ”§ IoT Devices</h4>
      <div id="devicesContainer" class="row"></div>
    </div>

    <!-- Logs -->
    <div class="mb-5">
      <h4>ðŸ“œ Logs</h4>
      <pre id="logsContainer" class="bg-dark text-light p-3 rounded" style="max-height: 300px; overflow-y: auto;"></pre>
    </div>

    <!-- Summary -->
    <div id="summaryContainer" class="text-center mb-5"></div>
  </div>
</div>

<script>
  document.getElementById("scanBtn").addEventListener("click", async () => {
    const btn = document.getElementById("scanBtn");
    const ota = document.getElementById("otaProgress");
    const recoverySection = document.getElementById("recoverySection");
    const mechContainer = document.getElementById("mechanismsContainer");
    const devContainer = document.getElementById("devicesContainer");
    const logs = document.getElementById("logsContainer");
    const summary = document.getElementById("summaryContainer");

    btn.disabled = true;
    btn.innerText = "â³ Scanning...";
    ota.style.width = "0%";
    ota.innerText = "0%";
    ota.className = "progress-bar bg-primary";
    recoverySection.style.display = "none";
    mechContainer.innerHTML = "";
    devContainer.innerHTML = "";
    logs.innerText = "";
    summary.innerHTML = "";

    // --- Animate OTA Progress to 100% ---
    let otaProgress = 0;
    const progressInterval = setInterval(() => {
      otaProgress += 2; // speed of fill
      if (otaProgress > 100) otaProgress = 100;

      ota.style.width = otaProgress + "%";
      ota.innerText = otaProgress + "%";

      if (otaProgress < 40) ota.className = "progress-bar bg-primary";
      else if (otaProgress < 80) ota.className = "progress-bar bg-warning";
      else ota.className = "progress-bar bg-success";

      if (otaProgress === 100) {
        clearInterval(progressInterval);
        loadResults();
      }
    }, 100);

    // --- Fetch Backend Data in Parallel ---
    let backendData = null;
    try {
      const res = await fetch("/api/recovery/scan", { method: "POST" });
      backendData = await res.json();
    } catch (err) {
      alert("âŒ Error during recovery scan: " + err);
      clearInterval(progressInterval);
      btn.disabled = false;
      btn.innerText = "ðŸ”„ Start Recovery Scan";
      return;
    }

    // --- Display Data After Progress Completes ---
    async function loadResults() {
      recoverySection.style.display = "block";

      // Mechanisms
      backendData.mechanisms.forEach(m => {
        const color =
          m.status === "completed" ? "success" :
          m.status === "in-progress" ? "warning" : "secondary";
        mechContainer.innerHTML += `
          <div class="col-md-6 mb-3">
            <div class="card border-${color}">
              <div class="card-body">
                <h5 class="card-title">${m.name}</h5>
                <p class="card-text">${m.description}</p>
                <span class="badge bg-${color}">${m.status}</span>
              </div>
            </div>
          </div>`;
      });

      // Devices
      backendData.devices.forEach(d => {
        const color = d.status === "recovered" ? "success" : "warning";
        devContainer.innerHTML += `
          <div class="col-md-3 mb-3">
            <div class="card border-${color}">
              <div class="card-body text-center">
                <h6>${d.name}</h6>
                <p class="text-muted">${d.type}</p>
                <span class="badge bg-${color}">${d.status}</span>
              </div>
            </div>
          </div>`;
      });

      // Logs
      logs.innerText = backendData.logs.join("\n");

      // Summary
      const recovered = backendData.devices.filter(d => d.status === "recovered").length;
      summary.innerHTML = `
        <div class="alert alert-success shadow-sm mt-4">
          âœ… <strong>Recovery Complete:</strong> ${recovered}/${backendData.devices.length} devices successfully recovered.
        </div>`;

      btn.disabled = false;
      btn.innerText = "ðŸ”„ Start Recovery Scan";
    }
  });
</script>

{% endblock %}