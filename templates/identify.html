<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Identify - IoT Asset Inventory | NIST Framework</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      :root {
        --primary-color: #2c3e50;
        --secondary-color: #3498db;
        --success-color: #27ae60;
        --warning-color: #f39c12;
        --danger-color: #e74c3c;
        --info-color: #2980b9;
      }

      body {
        background-color: #f8f9fa;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      .navbar {
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .dashboard-header {
        background: linear-gradient(
          135deg,
          var(--primary-color) 0%,
          var(--secondary-color) 100%
        );
        color: white;
        border-radius: 10px;
        padding: 2rem;
        margin-bottom: 2rem;
      }

      .stat-card {
        border-left: 4px solid;
        transition: transform 0.3s;
      }

      .stat-card:hover {
        transform: translateY(-5px);
      }

      .device-row {
        transition: all 0.3s;
      }

      .device-row:hover {
        background-color: #f8f9fa;
      }

      .risk-critical {
        border-left-color: var(--danger-color);
        background-color: rgba(220, 53, 69, 0.05);
      }
      .risk-high {
        border-left-color: var(--warning-color);
        background-color: rgba(255, 193, 7, 0.05);
      }
      .risk-medium {
        border-left-color: var(--info-color);
        background-color: rgba(23, 162, 184, 0.05);
      }
      .risk-low {
        border-left-color: var(--success-color);
        background-color: rgba(40, 167, 69, 0.05);
      }

      .scan-animation {
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
        100% {
          opacity: 1;
        }
      }
    </style>
  </head>
  <body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container">
        <a class="navbar-brand" href="{{ url_for('index') }}">
          <i class="fas fa-shield-alt me-2"></i> IoT NIST Monitor
        </a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <div class="navbar-nav ms-auto">
            <a class="nav-link" href="{{ url_for('index') }}">Dashboard</a>
            <a class="nav-link active" href="{{ url_for('identify') }}"
              >Identify</a
            >
            <a class="nav-link" href="{{ url_for('protect') }}">Protect</a>
            <a class="nav-link" href="{{ url_for('detect') }}">Detect</a>
            <a class="nav-link" href="{{ url_for('respond') }}">Respond</a>
            <a class="nav-link" href="{{ url_for('recover') }}">Recover</a>
            <a class="nav-link" href="{{ url_for('devicehive') }}"
              >DeviceHive</a
            >
            <a class="nav-link" href="{{ url_for('report') }}">Report</a>
          </div>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
      <!-- Flash Messages -->
      {% with messages = get_flashed_messages() %} {% if messages %} {% for
      message in messages %}
      <div class="alert alert-info alert-dismissible fade show" role="alert">
        {{ message }}
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="alert"
        ></button>
      </div>
      {% endfor %} {% endif %} {% endwith %}

      <!-- Dashboard Header -->
      <div class="dashboard-header">
        <div class="row align-items-center">
          <div class="col-md-8">
            <h1 class="display-5 fw-bold">IoT Asset Inventory</h1>
            <p class="lead mb-0">
              Real-time device discovery and analysis aligned with NIST Identify
              framework
            </p>
          </div>
          <div class="col-md-4 text-end">
            <a href="{{ url_for('devicehive') }}" class="btn btn-outline-light">
              <i class="fas fa-terminal me-2"></i>MQTT Logs
            </a>
          </div>
        </div>
      </div>

      <!-- Statistics Cards -->
      <div class="row mb-4">
        <div class="col-xl-2 col-md-4 mb-3">
          <div class="card stat-card h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div>
                  <h5 class="card-title">
                    {{ stats.total_devices if stats else 0 }}
                  </h5>
                  <p class="card-text">Total Devices</p>
                </div>
                <div class="align-self-center">
                  <i class="fas fa-microchip fa-2x text-primary"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-xl-2 col-md-4 mb-3">
          <div class="card stat-card h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div>
                  <h5 class="card-title">
                    {{ stats.active_devices if stats else 0 }}
                  </h5>
                  <p class="card-text">Active Devices</p>
                </div>
                <div class="align-self-center">
                  <i class="fas fa-wifi fa-2x text-success"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-xl-2 col-md-4 mb-3">
          <div class="card stat-card h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div>
                  <h5 class="card-title">
                    {{ stats.critical_devices if stats else 0 }}
                  </h5>
                  <p class="card-text">Critical Risk</p>
                </div>
                <div class="align-self-center">
                  <i class="fas fa-exclamation-triangle fa-2x text-danger"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-xl-2 col-md-4 mb-3">
          <div class="card stat-card h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div>
                  <h5 class="card-title">
                    {{ stats.devices_with_vulnerabilities if stats else 0 }}
                  </h5>
                  <p class="card-text">With Vulnerabilities</p>
                </div>
                <div class="align-self-center">
                  <i class="fas fa-bug fa-2x text-warning"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-xl-2 col-md-4 mb-3">
          <div class="card stat-card h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div>
                  <h5 class="card-title">
                    {{ stats.total_open_ports if stats else 0 }}
                  </h5>
                  <p class="card-text">Open Ports</p>
                </div>
                <div class="align-self-center">
                  <i class="fas fa-door-open fa-2x text-info"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-xl-2 col-md-4 mb-3">
          <div class="card stat-card h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div>
                  <h5 class="card-title">
                    {{ stats.device_types if stats else 0 }}
                  </h5>
                  <p class="card-text">Device Types</p>
                </div>
                <div class="align-self-center">
                  <i class="fas fa-shapes fa-2x text-secondary"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Scan Controls -->
      <div class="row mb-4">
        <div class="col-lg-8">
          <div class="card">
            <div class="card-header">
              <h5 class="card-title mb-0">
                <i class="fas fa-radar-dish text-warning me-2"></i>
                Network Discovery
              </h5>
            </div>
            <div class="card-body">
              <form method="POST" id="networkScanForm">
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label fw-bold">Network Range</label>
                      <select
                        class="form-select"
                        name="network_range"
                        id="networkRange"
                      >
                        {% for network in local_networks %}
                        <option value="{{ network }}">{{ network }}</option>
                        {% endfor %}
                        <option value="custom">Custom Range...</option>
                      </select>
                    </div>
                    <div
                      class="mb-3"
                      id="customRangeContainer"
                      style="display: none"
                    >
                      <label class="form-label fw-bold"
                        >Custom Network Range</label
                      >
                      <input
                        type="text"
                        class="form-control"
                        name="custom_range"
                        placeholder="e.g., 192.168.1.0/24"
                      />
                    </div>
                    <div class="mb-3">
                      <label class="form-label fw-bold">Scan Type</label>
                      <div>
                        <div class="form-check form-check-inline">
                          <input
                            class="form-check-input"
                            type="radio"
                            name="scan_type"
                            id="quickScan"
                            value="quick"
                            checked
                          />
                          <label class="form-check-label" for="quickScan"
                            >Quick Scan</label
                          >
                        </div>
                        <div class="form-check form-check-inline">
                          <input
                            class="form-check-input"
                            type="radio"
                            name="scan_type"
                            id="deepScan"
                            value="deep"
                          />
                          <label class="form-check-label" for="deepScan"
                            >Deep Scan</label
                          >
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label fw-bold">Scan Actions</label>
                      <div class="d-grid gap-2">
                        <button
                          type="submit"
                          name="network_scan"
                          class="btn btn-primary btn-lg scan-animation"
                        >
                          <i class="fas fa-search me-2"></i> Start Network Scan
                        </button>
                        {% if bluetooth_available %}
                        <button
                          type="submit"
                          name="bluetooth_scan"
                          class="btn btn-info"
                        >
                          <i class="fas fa-bluetooth me-2"></i> Scan Bluetooth
                          Devices
                        </button>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>

        <div class="col-lg-4">
          <div class="card h-100">
            <div class="card-header">
              <h5 class="card-title mb-0">
                <i class="fas fa-chart-line text-success me-2"></i>
                Scan Progress
              </h5>
            </div>
            <div class="card-body">
              <div id="scanProgress">
                <div class="progress mb-3" style="height: 20px">
                  <div
                    class="progress-bar progress-bar-striped progress-bar-animated"
                    role="progressbar"
                    style="width: 0%"
                    id="progressBar"
                  ></div>
                </div>
                <p class="mb-1 fw-bold" id="scanStatus">Ready to scan</p>
                <small class="text-muted" id="scanOperation"
                  >Select a network range and click Scan Network</small
                >
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Devices Table -->
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="fas fa-list-alt me-2"></i>
            Discovered IoT Devices
            <span class="badge bg-primary ms-2"
              >{{ combined_results|length }}</span
            >
          </h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Device Name</th>
                  <th>MAC Address</th>
                  <th>IP Address</th>
                  <th>Manufacturer</th>
                  <th>Type</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for device in combined_results %}
                <tr class="device-row">
                  <td>
                    <i class="fas fa-microchip text-primary me-2"></i>
                    <strong
                      >{{ device.device_name or device.name or 'Unknown'
                      }}</strong
                    >
                  </td>
                  <td><code>{{ device.mac_address or 'N/A' }}</code></td>
                  <td>{{ device.ip_address or 'N/A' }}</td>
                  <td>{{ device.manufacturer or 'Unknown' }}</td>
                  <td>
                    <span class="badge bg-secondary">
                      {{ device.device_type or 'Unknown' }}
                    </span>
                  </td>
                  <td>
                    <span class="badge bg-success">Active</span>
                  </td>
                  <td>
                    <div class="btn-group btn-group-sm">
                      <button class="btn btn-outline-info">
                        <i class="fas fa-eye"></i>
                      </button>
                      <button class="btn btn-outline-warning">
                        <i class="fas fa-chart-bar"></i>
                      </button>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
            {% if not combined_results %}
            <div class="text-center py-5">
              <i class="fas fa-search fa-4x text-muted mb-3"></i>
              <h5 class="text-muted">No devices discovered yet</h5>
              <p class="text-muted">
                Start a network scan to discover IoT devices in your network
              </p>
              <button
                class="btn btn-primary"
                onclick="document.getElementById('networkScanForm').submit()"
              >
                <i class="fas fa-bolt me-2"></i>Start Quick Scan
              </button>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Network Range Selector
      document
        .getElementById("networkRange")
        .addEventListener("change", function () {
          const customContainer = document.getElementById(
            "customRangeContainer"
          );
          if (this.value === "custom") {
            customContainer.style.display = "block";
          } else {
            customContainer.style.display = "none";
          }
        });

      // Simple scan progress simulation
      function simulateScanProgress() {
        const progressBar = document.getElementById("progressBar");
        const scanStatus = document.getElementById("scanStatus");
        const scanOperation = document.getElementById("scanOperation");

        let progress = 0;
        const interval = setInterval(() => {
          progress += 5;
          progressBar.style.width = progress + "%";

          if (progress <= 25) {
            scanStatus.textContent = "Scanning network...";
            scanOperation.textContent = "Discovering active hosts";
          } else if (progress <= 50) {
            scanStatus.textContent = "Port scanning...";
            scanOperation.textContent = "Identifying open ports";
          } else if (progress <= 75) {
            scanStatus.textContent = "Service detection...";
            scanOperation.textContent = "Detecting running services";
          } else if (progress <= 95) {
            scanStatus.textContent = "Finalizing...";
            scanOperation.textContent = "Compiling results";
          } else {
            scanStatus.textContent = "Scan completed!";
            scanOperation.textContent = "Scan finished successfully";
            clearInterval(interval);
            setTimeout(() => {
              location.reload();
            }, 2000);
          }
        }, 500);
      }

      // Start progress simulation when form is submitted
      document
        .getElementById("networkScanForm")
        .addEventListener("submit", function (e) {
          simulateScanProgress();
        });
    </script>
  </body>
</html>
